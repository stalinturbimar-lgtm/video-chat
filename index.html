<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Video Match</title>

<style>
body{
    margin:0;
    font-family:system-ui;
    background:#0f0f0f;
    color:white;
    text-align:center;
}
button,input{
    padding:12px;
    margin:6px;
    border-radius:8px;
    border:none;
    font-size:16px;
}
#videos{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
    gap:8px;
    padding:10px;
}
video{
    width:100%;
    border-radius:10px;
    background:black;
}
</style>
</head>

<body>

<h2>ðŸŽ¥ Match automÃ¡tico</h2>

<div id="menu">
    <input id="name" placeholder="Tu nombre">
    <br>
    <button onclick="start()">ðŸŽ² Empezar</button>
</div>

<div id="videos"></div>

<script>
let uid, room, peers={}, stream;

async function start(){
    let r = await fetch("/match",{
        method:"POST",
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({name:name.value||"Anon"})
    });
    let d = await r.json();
    uid=d.uid; room=d.room;

    menu.style.display="none";

    stream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    addVideo(stream,true);

    poll();
}

function addVideo(s,muted=false){
    let v=document.createElement("video");
    v.srcObject=s;
    v.autoplay=true;
    v.playsInline=true;
    v.muted=muted;
    videos.appendChild(v);
}

function createPeer(id){
    let pc=new RTCPeerConnection();
    stream.getTracks().forEach(t=>pc.addTrack(t,stream));

    pc.ontrack=e=>addVideo(e.streams[0]);
    pc.onicecandidate=e=>{
        if(e.candidate) send({to:id,candidate:e.candidate});
    };
    peers[id]=pc;
    return pc;
}

function send(signal){
    fetch("/signal",{
        method:"POST",
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({room,uid,signal})
    });
}

async function poll(){
    let r=await fetch("/poll",{
        method:"POST",
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({room,uid})
    });
    let data=await r.json();

    for(let m of data){
        let from=m.from;
        let s=m.signal;
        let pc=peers[from]||createPeer(from);

        if(s.offer){
            await pc.setRemoteDescription(s.offer);
            let ans=await pc.createAnswer();
            await pc.setLocalDescription(ans);
            send({answer:ans});
        }
        if(s.answer) await pc.setRemoteDescription(s.answer);
        if(s.candidate) await pc.addIceCandidate(s.candidate);
    }
    setTimeout(poll,800);
}

</script>
</body>
</html>
